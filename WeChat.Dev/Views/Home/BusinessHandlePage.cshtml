
@{
    ViewBag.Title = "BusinessHandlePage";
    Layout = "~/Views/Shared/_WeuiLayout.cshtml";
}
<div class="container" id="container" data-jssdkconfig='@Html.Raw(ViewBag.JSSDKConfig)'>
    <div class="weui-form-preview" id="handle_form_preview">

    </div>
    <div class="weui-form-preview__ft fixed_b">
        <a class="weui-form-preview__btn weui-form-preview__btn_default" href="javascript:window.history.back()">取消</a>
        <a class="weui-form-preview__btn weui-form-preview__btn_primary" onclick="getFormData(this)" href="javascript:">提交</a>
    </div>
</div>
@section scripts{
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/html" id="tpl_cclist">
        {{each ccItems}}
        <div class="cc-item">
            <img class="img-item" src="{{$value.avatar||'@Url.Content("~/Content/images/icon_tabbar.png")'}}" />
            <a href="javascript:;" class="cc-close" data-userid="{{$value.id}}">X</a>
        </div>
        {{/each}}
        <a href="javascript:;" class="cc-item cc-add"></a>
    </script>
    <script id="tpl_handleformpreview" type="text/html">
        <div class="weui-form-preview__hd">
            <label class="weui-form-preview__label">处理意见</label>
            <div class="weui-form-preview__value content">
                <div class="weui-cells weui-cells_form" style="margin-top:0;">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <textarea class="weui-textarea" id="suggestion" name="suggestion" rows="3"></textarea>
                            <div class="weui-textarea-counter"><span>0</span>/200</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="weui-form-preview__bd">
            {{if $data.ccComponent.show}}
            <div class="weui-form-preview__item">
                <label class="weui-form-preview__label">{{$data.ccComponent.label}}</label>
            </div>
            <div class="weui-form-preview__item text-left">
                <div class="cclist" id="cclist_items">
                    <a href="javascript:;" class="cc-item cc-add"></a>
                </div>
            </div>
            {{/if}}
            {{if $data.stepComponent.show}}
            <div class="weui-form-preview__item">
                <label class="weui-form-preview__label">{{$data.stepComponent.label}}</label>
                <span class="weui-form-preview__value">名字名字名字</span>
            </div>
            {{/if}}
            {{if $data.principalComponent.show}}
            <div class="weui-form-preview__item">
                <label class="weui-form-preview__label">{{$data.principalComponent.label}}</label>
                <span class="weui-form-preview__value">很长很长的名字很长很长的名字很长很长的名字很长很长的名字很长很长的名字</span>
            </div>
            {{/if}}
            {{if $data.switchComponent.show}}
            <div class="weui-form-preview__item text-left">
                <div class="weui-cell weui-cell_switch" style="padding-left:0;padding-right:0;">
                    <div class="weui-cell__bd">{{$data.switchComponent.label}}</div>
                    <div class="weui-cell__ft">
                        <input class="weui-switch" type="checkbox">
                    </div>
                </div>
            </div>
            {{/if}}
        </div>
    </script>
    <script>
        var ccids = [];
        try {
            init();
            initJSSDK();
            bindEvents();
        } catch (e) {
            console.error(e)
            weui.alert(e.message)
        }

        function init() {
            var previewEl = document.querySelector('#handle_form_preview');
            var preview = template('tpl_handleformpreview', {
                contentComponent: {
                    value: ''
                },
                stepComponent: {
                    label: '下一处理步骤',
                    show: true
                },
                principalComponent: {
                    label: '下一步责任人',
                    show: true
                },
                switchComponent: {
                    label: '是否打回重走',
                    show: false
                },
                ccComponent: {
                    label: '抄送人', //协商人 接收人
                    show: true
                }
            });
            previewEl.innerHTML = preview;
        }

        function bindEvents() {
            var el = document.getElementById('cclist_items');
            el.addEventListener('click', function (e) {
                var sourceEl = e.target;
                var selectEl = this.querySelector('a.cc-add');
                if (sourceEl.tagName.toLowerCase() === 'a' && sourceEl.classList.contains('cc-add')) {
                    //添加
                    //alert("打开通讯录");
                    invokeAddressList();
                } else if (sourceEl.tagName.toLowerCase() === 'a' && sourceEl.classList.contains('cc-close')) {
                    //删除
                    removeCCElment(sourceEl);
                }
                console.log(e.target.classList)
                console.log(sourceEl.classList.contains('cc-add'))
                console.log(e.target.tagName.toLowerCase() === 'a')
            })
        }

        function initJSSDK() {

            var containerEl = document.getElementById('container');
            var jssdkconfig = JSON.parse(containerEl.dataset.jssdkconfig);
            var defaults = {
                beta: true,// 必须这么写，否则在微信插件有些jsapi会有问题
                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                jsApiList: ['selectEnterpriseContact'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
            };
            var options = Object.assign(defaults, jssdkconfig);

            console.log(defaults)
            console.log(jssdkconfig);
            console.log(options);

            wx.config(options);

            wx.ready(function () {
                // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
            });
            wx.error(function (res) {
                // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
                weui.alert(JSON.stringify(res));
            });
        }

        //唤醒通讯录
        function invokeAddressList() {
            var cclistEl = document.querySelector('#cclist_items');
            var lastChildEl = cclistEl.querySelector('a.cc-add');
            var selectedUserIds = cclistEl.dataset.selectUserids || ccids || [];
            wx.invoke("selectEnterpriseContact", {
                "fromDepartmentId": 0,// 必填，-1表示打开的通讯录从自己所在部门开始展示, 0表示从最上层开始
                "mode": "multi",// 必填，选择模式，single表示单选，multi表示多选
                //"type": ["department", "user"],// 必填，选择限制类型，指定department、user中的一个或者多个
                "type": ["user"],
                "selectedDepartmentIds": [],// 非必填，已选部门ID列表。用于多次选人时可重入
                "selectedUserIds": selectedUserIds// 非必填，已选用户ID列表。用于多次选人时可重入
            }, function (res) {
                if (res.err_msg == "selectEnterpriseContact:ok") {
                    //alert(JSON.stringify(res.result));
                    if (typeof res.result == 'string') {
                        res.result = JSON.parse(res.result) //由于目前各个终端尚未完全兼容，需要开发者额外判断result类型以保证在各个终端的兼容性
                    }
                    //var selectedDepartmentList = res.result.departmentList;// 已选的部门列表
                    //for (var i = 0; i < selectedDepartmentList.length; i++) {
                    //    var department = selectedDepartmentList[i];
                    //    var departmentId = department.id;// 已选的单个部门ID
                    //    var departemntName = department.name;// 已选的单个部门名称
                    //}
                    var selectedUserList = res.result.userList; // 已选的成员列表
                    //var fragment = document.createDocumentFragment();
                    //for (var i = 0; i < selectedUserList.length; i++) {
                    //    var user = selectedUserList[i];
                    //    //var userId = user.id; // 已选的单个成员ID
                    //    //var userName = user.name;// 已选的单个成员名称
                    //    //var userAvatar = user.avatar;// 已选的单个成员头像
                    //    var ccEl = document.createElement('div');
                    //    var img = document.createElement('img');
                    //    var aClose = document.createElement('a');
                    //    img.src = user.avatar;
                    //    img.classList.add('img-item');
                    //    aClose.classList.add('cc-close');
                    //    aClose.dataset.id = user.id;
                    //    aClose.href = "javascript:;";
                    //    aClose.innerText = "X";
                    //    ccEl.classList.add('cc-item');
                    //    ccEl.appendChild(img);
                    //    ccEl.appendChild(aClose);
                    //    fragment.appendChild(ccEl);
                    //}
                    //cclistEl.insertBefore(fragment, lastChildEl);
                    addCCElement(selectedUserList)
                }
            });
        }

        //过滤
        function filterCCData(data) {
            var cclistEl = document.querySelector('#cclist_items');
            ccids = data.map(function (cc) {
                return cc.id;
            });
            cclistEl.dataset.selectUserids = JSON.stringify(ccids);
            return data;
        }

        //添加抄送人
        function addCCElement(data) {
            var result = filterCCData(data);
            var ccEl = null, imgEl = null, closeEl = null,
                fragment = document.createDocumentFragment();
            result.forEach(function (cc) {
                ccEl = document.createElement('div');
                imgEl = document.createElement('img');
                closeEl = document.createElement('a');

                imgEl.src = cc.avatar;
                imgEl.classList.add('img-item');
                closeEl.classList.add('cc-close');
                closeEl.dataset.userid = cc.id;
                closeEl.href = "javascript:;";
                closeEl.innerText = "X";
                ccEl.classList.add('cc-item');
                ccEl.appendChild(imgEl);
                ccEl.appendChild(closeEl);
                fragment.appendChild(ccEl);
            })
            var cclistEl = document.querySelector('#cclist_items');
            var lastChildEl = cclistEl.querySelector('a.cc-add');
            cclistEl.insertBefore(fragment, lastChildEl);
        }

        //删除抄送人
        function removeCCElment(sourceEl) {
            var cclistEl = document.querySelector('#cclist_items');
            var parentNode = sourceEl.parentNode;
            var userid = sourceEl.dataset.userid;

            var delIndex = ccids.findIndex(function (ccid) {
                return ccid == userid;
            })

            ccids.splice(delIndex, 1);
            cclistEl.dataset.selectUserids = JSON.stringify(ccids);
            parentNode.remove();
        }

        //获取表单数据
        function getFormData(el) {
            el.classList.add('weui-btn_loading');
            el.style.background = '#eee';
            el.style.color = '#999';
            el.innerHTML = '<i class="weui-loading"></i> Loading';
            var form = {
                ccids: ccids,
                suggestion: document.getElementById('suggestion').value
            }
            weui.alert(JSON.stringify(form), function () {
                el.classList.remove('weui-btn_loading');
                el.style.background = '';
                el.innerHTML = '提交';
            })
        }
    </script>
}
